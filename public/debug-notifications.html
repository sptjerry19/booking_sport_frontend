<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug Notifications</title>
    <link rel="manifest" href="/manifest.json" />
  </head>
  <body>
    <h1>ğŸ”§ Debug Push Notifications</h1>
    <div style="padding: 20px; font-family: Arial, sans-serif">
      <button
        onclick="runDebugTests()"
        style="
          padding: 10px 20px;
          background: #3b82f6;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
        "
      >
        ğŸ§ª Cháº¡y Debug Tests
      </button>

      <div
        id="results"
        style="
          margin-top: 20px;
          padding: 15px;
          background: #f8f9fa;
          border-radius: 5px;
          white-space: pre-wrap;
          font-family: monospace;
        "
      ></div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
      import {
        getMessaging,
        getToken,
      } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-messaging.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCvhBj3HKY6kTTzKvd4ctizmShph_gQrcg",
        authDomain: "yumic-83e7d.firebaseapp.com",
        projectId: "yumic-83e7d",
        storageBucket: "yumic-83e7d.firebasestorage.app",
        messagingSenderId: "939100829101",
        appId: "1:939100829101:web:1f2cd113d5bb771de69d24",
        measurementId: "G-MWQ68ZTMTN",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const messaging = getMessaging(app);

      window.runDebugTests = async function () {
        const results = document.getElementById("results");
        let output = "ğŸ”§ DEBUG NOTIFICATIONS TEST\n\n";

        try {
          // Test 1: Browser Support
          output += "1ï¸âƒ£ Kiá»ƒm tra Browser Support:\n";
          const hasServiceWorker = "serviceWorker" in navigator;
          const hasNotification = "Notification" in window;
          output += `   - ServiceWorker: ${hasServiceWorker ? "âœ…" : "âŒ"}\n`;
          output += `   - Notification API: ${hasNotification ? "âœ…" : "âŒ"}\n`;
          output += `   - Current permission: ${Notification.permission}\n\n`;

          if (!hasServiceWorker || !hasNotification) {
            output += "âŒ Browser khÃ´ng há»— trá»£ Push Notifications\n";
            results.textContent = output;
            return;
          }

          // Test 2: Service Worker Registration
          output += "2ï¸âƒ£ ÄÄƒng kÃ½ Service Worker:\n";
          try {
            const registration = await navigator.serviceWorker.register(
              "/firebase-messaging-sw.js"
            );
            output += `   âœ… Service Worker Ä‘Äƒng kÃ½ thÃ nh cÃ´ng\n`;
            output += `   ğŸ“ Scope: ${registration.scope}\n`;
            output += `   ğŸ“ State: ${
              registration.active?.state || "installing"
            }\n\n`;
          } catch (swError) {
            output += `   âŒ Service Worker failed: ${swError.message}\n\n`;
            results.textContent = output;
            return;
          }

          // Test 3: Request Permission
          output += "3ï¸âƒ£ YÃªu cáº§u quyá»n thÃ´ng bÃ¡o:\n";
          try {
            const permission = await Notification.requestPermission();
            output += `   ğŸ“‹ Permission result: ${permission}\n\n`;

            if (permission !== "granted") {
              output += "âŒ Permission bá»‹ tá»« chá»‘i hoáº·c dismissed\n";
              results.textContent = output;
              return;
            }
          } catch (permError) {
            output += `   âŒ Permission request failed: ${permError.message}\n\n`;
            results.textContent = output;
            return;
          }

          // Test 4: Get FCM Token
          output += "4ï¸âƒ£ Láº¥y FCM Token:\n";
          try {
            const vapidKey =
              "BJnxxyu-A79LKcjnuJ9k6VWhFS_bLnTV7DtDursl0OZzs7e3dTwgyWmGjb1dPuc-AgTb3Clp8eCoVJG4UX6vLq4";
            output += `   ğŸ”‘ VAPID Key: ${vapidKey.substring(0, 20)}...\n`;

            const token = await getToken(messaging, { vapidKey });

            if (token) {
              output += `   ğŸ‰ FCM Token generated successfully!\n`;
              output += `   ğŸ“‹ Token (first 50 chars): ${token.substring(
                0,
                50
              )}...\n`;
              output += `   ğŸ“ Token length: ${token.length} characters\n\n`;
              output += "âœ… PUSH NOTIFICATIONS SETUP THÃ€NH CÃ”NG!\n";
            } else {
              output += "   âŒ KhÃ´ng thá»ƒ generate FCM token\n";
            }
          } catch (tokenError) {
            output += `   âŒ FCM Token failed: ${tokenError.message}\n`;
            output += `   ğŸ” Error code: ${tokenError.code}\n`;
            output += `   ğŸ“š Error stack: ${tokenError.stack}\n`;
          }
        } catch (globalError) {
          output += `ğŸ’¥ Global error: ${globalError.message}\n`;
          output += `ğŸ“š Stack: ${globalError.stack}\n`;
        }

        results.textContent = output;
      };
    </script>
  </body>
</html>
